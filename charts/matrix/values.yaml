# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-4.3.0/charts/other/app-template/values.schema.json

controllers:
  main:
    strategy: Recreate
    containers:
      main:
        image:
          repository: matrixdotorg/synapse
          tag: 1.88.2
          pullPolicy: IfNotPresent
        env:
          SYNAPSE_SERVER_NAME: matrix.cluster.diluz.io
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
        probes:
          liveness:
            enabled: true
            type: HTTP
            path: /_matrix/client/versions
            port: 8008
            spec:
              failureThreshold: 10
              initialDelaySeconds: 5
          readiness:
            enabled: true
            type: HTTP
            path: /_matrix/client/versions
            port: 8008
            spec:
              failureThreshold: 10
              initialDelaySeconds: 5

service:
  main:
    controller: main
    ports:
      http:
        port: 8008

defaultPodOptions:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 1
          preference:
            matchExpressions:
              - key: kubernetes.io/role
                operator: In
                values:
                  - worker

persistence:
  data:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 5Gi
    storageClass: 'nfs-client'

# Postgres and Redis subchart settings (Bitnami charts)
postgresql:
  enabled: true
  auth:
    # override in consumers/values if you want a specific password
    password: 'TODO_CHANGE_ME'
  # also set legacy-style global key used elsewhere in this repo
  global:
    postgresql:
      auth:
        password: 'TODO_CHANGE_ME'
  primary:
    persistence:
      enabled: true
      storageClass: nfs-client
      size: 10Gi

redis:
  enabled: true
  architecture: standalone
  master:
    persistence:
      enabled: false
  # Redis auth password for the Bitnami chart
  auth:
    password: 'TODO_CHANGE_REDIS_PASSWORD'

# Synapse-specific settings
synapse:
  enabled: true
  image:
    repository: matrixdotorg/synapse
    tag: 1.88.2
    pullPolicy: IfNotPresent
  replicaCount: 1
  service:
    port: 8008
  persistence:
    enabled: true
    storageClass: nfs-client
    size: 5Gi

  # Extra environment variables to pass to the container
  extraEnv: {}
